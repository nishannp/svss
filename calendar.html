<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepali-English Calendar</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .calendar-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #dee2e6;
            padding: 10px;
            min-height: 120px;
            position: relative;
        }
        
        .calendar-day.holiday {
            background-color: rgba(255, 0, 0, 0.1);
        }
        
        .calendar-day:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .nepali-date {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .english-date {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .event-dot {
            width: 8px;
            height: 8px;
            background-color: #007bff;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .event-list {
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
                font-size: 0.8rem;
            }
            
            .nepali-date {
                font-size: 1rem;
            }
            
            .english-date {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="calendar-header text-center">
            <div class="row align-items-center">
                <div class="col">
                    <button class="btn btn-outline-primary" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="col-6">
                    <h2 id="currentMonth"></h2>
                    <p id="currentYear" class="mb-0"></p>
                </div>
                <div class="col">
                    <button class="btn btn-outline-primary" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col text-center">Sun</div>
            <div class="col text-center">Mon</div>
            <div class="col text-center">Tue</div>
            <div class="col text-center">Wed</div>
            <div class="col text-center">Thu</div>
            <div class="col text-center">Fri</div>
            <div class="col text-center">Sat</div>
        </div>
        
        <div id="calendar" class="row g-0"></div>
    </div>

    <!-- Event Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Events</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="eventDetails">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
let calendarData = [];
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let currentNepaliMonth;
let currentNepaliYear;
const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

async function fetchCalendarData() {
    try {
        const response = await fetch("https://api.saralpatro.com/graphql", {
            credentials: "omit",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                query: `
                    {
                        dates(bsYear: 2081) {
                            bsDay
                            bsMonth
                            bsYear
                            adDay
                            adMonth
                            adYear
                            weekday
                            isHoliday
                            events {
                                strEn
                                strNp
                                isHoliday
                            }
                        }
                    }
                `
            }),
            method: "POST",
            mode: "cors"
        });

        const data = await response.json();
        calendarData = data.data.dates;
        
        // Find current date in the calendar data
        const today = new Date();
        const currentDate = calendarData.find(date => 
            date.adYear === today.getFullYear() &&
            date.adMonth === (today.getMonth() + 1) &&
            date.adDay === today.getDate()
        );

        if (currentDate) {
            currentNepaliMonth = currentDate.bsMonth - 1; // Convert to 0-based index
            currentNepaliYear = currentDate.bsYear;
            currentMonth = currentDate.adMonth - 1; // Convert to 0-based index
            currentYear = currentDate.adYear;
        }

        renderCalendar();
    } catch (error) {
        console.error("Error fetching calendar data:", error);
    }
}

function renderCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    
    // Filter data for current Nepali month
    const monthData = calendarData.filter(date => 
        date.bsMonth === currentNepaliMonth + 1
    );

    if (monthData.length === 0) return;

    // Find first day of month
    const firstDay = monthData[0].weekday;
    
    // Create empty cells for days before first day of month
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = createDayElement();
        calendar.appendChild(emptyDay);
    }

    // Create cells for each day of the month
    monthData.forEach(date => {
        const dayElement = createDayElement(date);
        
        // Highlight current day
        const today = new Date();
        if (date.adYear === today.getFullYear() &&
            date.adMonth === (today.getMonth() + 1) &&
            date.adDay === today.getDate()) {
            dayElement.style.backgroundColor = '#e3f2fd';
            dayElement.style.border = '2px solid #1976d2';
        }
        
        calendar.appendChild(dayElement);
    });

    // Update header
    document.getElementById('currentMonth').textContent = 
        `${getNepaliMonth(currentNepaliMonth)} / ${getEnglishMonth(currentMonth)}`;
    document.getElementById('currentYear').textContent = 
        `${monthData[0].bsYear} / ${monthData[0].adYear}`;
}

function createDayElement(date = null) {
    const div = document.createElement('div');
    div.className = 'col calendar-day';
    
    if (!date) return div;

    if (date.isHoliday) {
        div.classList.add('holiday');
    }

    // Add Nepali date
    const nepaliDate = document.createElement('div');
    nepaliDate.className = 'nepali-date';
    nepaliDate.textContent = date.bsDay;
    div.appendChild(nepaliDate);

    // Add English date
    const englishDate = document.createElement('div');
    englishDate.className = 'english-date';
    englishDate.textContent = date.adDay;
    div.appendChild(englishDate);

    // Add events if any
    if (date.events && date.events.length > 0) {
        const eventList = document.createElement('div');
        eventList.className = 'event-list';
        date.events.slice(0, 2).forEach(event => {
            const eventDot = document.createElement('span');
            eventDot.className = 'event-dot';
            eventList.appendChild(eventDot);
        });
        div.appendChild(eventList);
    }

    // Add click handler
    div.addEventListener('click', () => showEvents(date));

    return div;
}

function showEvents(date) {
    const modalBody = document.getElementById('eventDetails');
    modalBody.innerHTML = `
        <h6>${date.bsDay} ${getNepaliMonth(date.bsMonth - 1)} ${date.bsYear}</h6>
        <h6>${date.adDay} ${getEnglishMonth(date.adMonth - 1)} ${date.adYear}</h6>
        <hr>
    `;

    if (date.events && date.events.length > 0) {
        const eventsList = document.createElement('ul');
        eventsList.className = 'list-group';
        date.events.forEach(event => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `
                <div>${event.strEn}</div>
                <div class="text-muted">${event.strNp}</div>
            `;
            eventsList.appendChild(li);
        });
        modalBody.appendChild(eventsList);
    } else {
        modalBody.innerHTML += '<p>No events for this day</p>';
    }

    eventModal.show();
}

function getNepaliMonth(month) {
    const months = [
        'Baisakh', 'Jestha', 'Ashadh', 'Shrawan', 
        'Bhadra', 'Ashwin', 'Kartik', 'Mangsir',
        'Poush', 'Magh', 'Falgun', 'Chaitra'
    ];
    return months[month];
}

function getEnglishMonth(month) {
    const months = [
        'January', 'February', 'March', 'April',
        'May', 'June', 'July', 'August',
        'September', 'October', 'November', 'December'
    ];
    return months[month];
}

// Navigation button handlers
document.getElementById('prevMonth').addEventListener('click', () => {
    const firstDayOfCurrentMonth = calendarData.find(date => 
        date.bsMonth === currentNepaliMonth + 1 &&
        date.bsDay === 1
    );
    
    const prevMonthData = calendarData.find(date => 
        date.adYear === firstDayOfCurrentMonth.adYear &&
        date.adMonth === firstDayOfCurrentMonth.adMonth - 1 &&
        date.bsDay === 1
    ) || calendarData.find(date => 
        date.adYear === firstDayOfCurrentMonth.adYear - 1 &&
        date.adMonth === 12 &&
        date.bsDay === 1
    );

    if (prevMonthData) {
        currentNepaliMonth = prevMonthData.bsMonth - 1;
        currentNepaliYear = prevMonthData.bsYear;
        currentMonth = prevMonthData.adMonth - 1;
        currentYear = prevMonthData.adYear;
        renderCalendar();
    }
});

document.getElementById('nextMonth').addEventListener('click', () => {
    const firstDayOfCurrentMonth = calendarData.find(date => 
        date.bsMonth === currentNepaliMonth + 1 &&
        date.bsDay === 1
    );
    
    const nextMonthData = calendarData.find(date => 
        date.adYear === firstDayOfCurrentMonth.adYear &&
        date.adMonth === firstDayOfCurrentMonth.adMonth + 1 &&
        date.bsDay === 1
    ) || calendarData.find(date => 
        date.adYear === firstDayOfCurrentMonth.adYear + 1 &&
        date.adMonth === 1 &&
        date.bsDay === 1
    );

    if (nextMonthData) {
        currentNepaliMonth = nextMonthData.bsMonth - 1;
        currentNepaliYear = nextMonthData.bsYear;
        currentMonth = nextMonthData.adMonth - 1;
        currentYear = nextMonthData.adYear;
        renderCalendar();
    }
});

// Initialize calendar
fetchCalendarData();
    </script>
</body>
</html>