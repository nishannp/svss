<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Reviews Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .teachers-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .teacher-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .teacher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .teacher-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .teacher-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .reviews-container {
            margin-top: 15px;
        }

        .review-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .review-content {
            flex-grow: 1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .user-image {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #cc0000;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            color: #cc0000;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success-message {
            background: #e6ffe6;
            color: #006600;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teacher Reviews Admin Panel</h1>
        <div id="teachers-container" class="teachers-section">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script>
        // Initialize Supabase client - Fixed initialization
        const SUPABASE_URL = 'https://oyjqllqplktgruvebfap.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95anFsbHFwbGt0Z3J1dmViZmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzIxMDU1NDcsImV4cCI6MjA0NzY4MTU0N30.QLaVHoTfK5XmdemfJq--yObvkUr28jWhdoUIKTjTeq8';
        
        // Create Supabase client correctly
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Main function to load teachers and their reviews
        async function loadTeachersAndReviews() {
            try {
                // Fetch teachers with their reviews
                const { data: teachers, error: teachersError } = await supabaseClient
                    .from('teachers')
                    .select(`
                        *,
                        teacher_reviews (*)
                    `)
                    .order('name');

                if (teachersError) throw teachersError;

                const container = document.getElementById('teachers-container');
                container.innerHTML = ''; // Clear loading message

                if (!teachers || teachers.length === 0) {
                    container.innerHTML = '<p>No teachers found.</p>';
                    return;
                }

                teachers.forEach(teacher => {
                    const teacherElement = createTeacherElement(teacher);
                    container.appendChild(teacherElement);
                });
            } catch (error) {
                showError('Error loading data: ' + error.message);
            }
        }

        // Create HTML element for a teacher and their reviews
        function createTeacherElement(teacher) {
            const teacherDiv = document.createElement('div');
            teacherDiv.className = 'teacher-card';

            teacherDiv.innerHTML = `
                <div class="teacher-header">
                    <div class="teacher-info">
                        ${teacher.teacher_image 
                            ? `<img src="${teacher.teacher_image}" alt="${teacher.name}" class="teacher-image">` 
                            : ''}
                        <div>
                            <h2>${teacher.name}</h2>
                            <p>${teacher.department || 'No department'}</p>
                        </div>
                    </div>
                </div>
                <div class="reviews-container">
                    ${teacher.teacher_reviews && teacher.teacher_reviews.length 
                        ? teacher.teacher_reviews.map(review => createReviewHTML(review)).join('')
                        : '<p>No reviews yet</p>'}
                </div>
            `;

            return teacherDiv;
        }

        // Create HTML for a single review
        function createReviewHTML(review) {
            return `
                <div class="review-item" data-review-id="${review.id}">
                    <div class="review-content">
                        <div class="user-info">
                            ${review.user_image_url 
                                ? `<img src="${review.user_image_url}" alt="${review.user_name}" class="user-image">` 
                                : ''}
                            <span>${review.user_name}</span>
                        </div>
                        <p>${review.review_text}</p>
                    </div>
                    <button class="delete-btn" onclick="deleteReview('${review.id}')">Delete</button>
                </div>
            `;
        }

        // Delete a review with improved error handling and feedback
        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;

            try {
                const { error } = await supabaseClient
                    .from('teacher_reviews')
                    .delete()
                    .eq('id', reviewId); // Changed .match to .eq for proper comparison

                if (error) throw error;

                // Remove the review element from the DOM only after successful deletion
                const reviewElement = document.querySelector(`[data-review-id="${reviewId}"]`);
                if (reviewElement) {
                    reviewElement.remove();
                    showSuccess('Review deleted successfully');
                }
            } catch (error) {
                showError('Error deleting review: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('teachers-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            // Remove error message after 3 seconds
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // Show success message
        function showSuccess(message) {
            const container = document.getElementById('teachers-container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);
            
            // Remove success message after 3 seconds
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadTeachersAndReviews);
    </script>
</body>
</html>